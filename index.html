<!DOCTYPE html>
<html>
    <head>
        
	<script type="text/javascript" src="https://d3js.org/d3-random.v1.min.js"></script>
	<script src="https://d3js.org/d3.v4.min.js"></script>
	<script src="http://d3js.org/topojson.v2.min.js"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js"></script>       
    <link href="https://fonts.googleapis.com/css?family=Open+Sans+Condensed:300|Quicksand" rel="stylesheet">
    <title>Project 2</title>
    <meta charset="utf-8">
    <style>
            body { 
                font-family: 'Quicksand', sans-serif;
            }
            
            h1{
                text-align: center;
                font-family: 'Quicksand', sans-serif;
                font-size: 40;
            }
            p {
                font-family: 'Quicksand', sans-serif;
                font-size:30;
                font-weight:Bold;
            }
    </style>      
    </head>
    <body>
        
        <h1> FastFood Density Versus Obesity</h1>

        <script>

			var projection =  d3.geoAlbersUsa()
                .scale([600])
                .translate([550 / 2, 700 / 2]);

			var path = d3.geoPath().projection(projection);	
			var states, restmap, us, freq;
			
            var height = 500;
            var width = 500;
            var margin = {top: 20, right: 20, bottom: 110, left: 50};
            
            var svg = d3.select("body").append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom);

            var usmap = d3.select("body").append("svg")
				.attr("width", 600)
				.attr("height", 700);
			
            var P = [];
            var C = [];
            var I = [];
            
            var merged = [];
            
            var imageRef = [{ name: "AppleBees", logo: "http://www.horadecomer.com/uploads/images/logos/logo-applebees.png" },
                            { name: "Burger King", logo: "https://upload.wikimedia.org/wikipedia/commons/thumb/3/3a/Burger_King_Logo.svg/2000px-Burger_King_Logo.svg.png"}, { name: "Chick-fil-A", logo: "http://vignette4.wikia.nocookie.net/logopedia/images/6/68/Chick-fil-A_logo_2012.png/revision/latest?cb=20130511041847"}, 
                            { name: "Chipotle", logo: "https://upload.wikimedia.org/wikipedia/en/thumb/3/3b/Chipotle_Mexican_Grill_logo.svg/480px-Chipotle_Mexican_Grill_logo.svg.png"}, 
                            {name: "Dairy Queen", logo: "https://upload.wikimedia.org/wikipedia/commons/thumb/a/ae/Dairy_Queen_logo.svg/1280px-Dairy_Queen_logo.svg.png"}, {name: "Five Guys", logo: "http://logos-download.com/wp-content/uploads/2016/04/Five_Guys_logo_logotype_burgers_and_fries.png"},
                            {name: "Hardee's", logo: "http://www.reach-holding.com/resources/hardees.png"},
                            {name: "Carl's", logo: "https://upload.wikimedia.org/wikipedia/en/thumb/0/07/Carl%27s_Jr._Signage.svg/546px-Carl%27s_Jr._Signage.svg.png"}, {name: "In-N-Out", logo: "https://upload.wikimedia.org/wikipedia/commons/thumb/f/f2/InNOut.svg/1200px-InNOut.svg.png" },
                            {name: "KFC", logo: "https://upload.wikimedia.org/wikipedia/en/thumb/b/bf/KFC_logo.svg/1024px-KFC_logo.svg.png" },
                            {name: "McDonald's", logo:"http://diylogodesigns.com/blog/wp-content/uploads/2016/04/Mcdonalds-logo-png-Transparent.png"},
                            {name: "Papa John's", logo:"http://logos-download.com/wp-content/uploads/2016/04/Papa_Johns_logo_logotype.png"},
                            {name: "Starbucks", logo: "https://upload.wikimedia.org/wikipedia/en/thumb/3/35/Starbucks_Coffee_Logo.svg/1024px-Starbucks_Coffee_Logo.svg.png"},
                            {name: "Wendy's", logo:"http://www.creginc.com/images/tenants/Wendys-logo.png"}, 
                            {name:"White Castle", logo: "https://upload.wikimedia.org/wikipedia/en/thumb/e/e1/White_Castle_logo.svg/1197px-White_Castle_logo.svg.png"},
                            {name:"Subway", logo:"http://logos-download.com/wp-content/uploads/2016/03/Subway_logo_logotype_emblem.png"}];
           
            d3.queue()
                .defer(d3.csv, "price1.csv")
                .defer(d3.csv, "calories.csv")
                .defer(d3.csv, "FastFood.csv")
				.defer(d3.json, "us.json")
				.defer(d3.csv, "OB_AND_FF_FREQ.csv")
                .await(function (err, price, calories, income, d1, d2) {
				
				if(err) { console.log(err); }

				freq = d2;
				us = d1;						
				freq.forEach(function(d) {
					d["Fast-food restaurants per 10,000 residents"] = +Number(d["Fast-food restaurants per 10,000 residents"]);
					d["% of residents who are obese"] = +Number(d["% of residents who are obese"]);
					d["Food Insercurity % (2010-12)"] = +Number(d["Food Insercurity % (2010-12)"]);
					d["McDonald's"] = +Number(d["McDonald's"]);
					d["Burger King"] = +Number(d["Burger King"]);
					d["Wendy's"] = +Number(d["Wendy's"]);
					d["Carl's"] = +Number(d["Carl's"]);
					d["Chick-fil-A"] = +Number(d["Chick-fil-A"]);
					d["Chipotle"] = +Number(d["Chipotle"]);
					d["Dairy Queen"] = +Number(d["Dairy Queen"]);
					d["FIPS"] = +Number(d["FIPS"]);			
					d["Hardee's"] = +Number(d["Hardee's"]);
					d["In-N-Out"] = +Number(d["In-N-Out"]);
					d["Jack in the Box"] = +Number(d["Jack in the Box"]);
					d["Papa John's"] = +Number(d["Papa John's"]);
					d["Sonic"] = +Number(d["Sonic"]);
					d["Subway"] = +Number(d["Subway"]);
					d["Whataburger"] = +Number(d["Whataburger"]);
					d["White Castle"] = +Number(d["White Castle"]);
				});             

				var rest_Extent = d3.extent(freq, function(d) {
					return d["Fast-food restaurants per 10,000 residents"];
				});	
				var ob_Extent = d3.extent(freq, function(d) {
					return d["% of residents who are obese"];
				});		
		
				var insec_Extent = d3.extent(freq, function(d) {
					return d["Food Insercurity % (2010-12)"];
				});	

				var color_r = d3.scaleQuantize()
					.domain(rest_Extent)
					.range(["#ffffff", "#ffdacc", "##ffb699", "#ffa07a", "#ff7f4d", "#ff5b1a", "#e64100", "#b33300", "#802400", "#4d1600"]);
				
				states = topojson.feature(us, us.objects.states);
		
				restmap = d3.map(freq, function (d) { return d["FIPS"];} );	

                //Append a defs (for definition) element to your SVG
                var defs = usmap.append("defs");
                
                //Append a linearGradient element to the defs and give it a unique id
                var linearGradient = defs.append("linearGradient")
                    .attr("id", "linear-gradient")
                    .attr("x1", "0%")
                    .attr("y1", "0%")
                    .attr("x2", "100%")
                    .attr("y2", "0%");
                
                linearGradient.append("stop") 
                    .attr("offset", "0%")   
                    .attr("stop-color", "#ffffff"); 
                
                linearGradient.append("stop") 
                    .attr("offset", "50%")   
                    .attr("stop-color", "#ff7f4d"); 
                
                linearGradient.append("stop") 
                    .attr("offset", "100%")   
                    .attr("stop-color", "#4d1600");
                
                usmap.append("rect")
                    .attr("x", 150)
                    .attr("y", 550)
                    .attr("width", 300)
                    .attr("height", 20)
//                    .attr("stroke-width", 1)
//                    .attr("stroke", "black")
                    .style("fill", "url(#linear-gradient)");

			   
			   //processing information about price   
                    priceData = d3.nest()
                        .key(function(d) { return d.FastFood;})
                        .rollup(function(price) {
                            return {
                            "averagePrice" : d3.mean(price, function(d) {return(d.Price)})
                        }
                    })
                    .entries(price);
                
                    for(var i = 0; i < priceData.length; i++){
                
                        var n = Object.values(priceData[i].value)
                        var x = Number(n);

                        var calorieInfo = { fastfood : priceData[i].key,
                                            cost: x
                                          }

                        P.push(calorieInfo);
                    }
                    
                //processing info from calories.csv
                    caloriesData = d3.nest()
                        .key(function(d) { return d.Fastfood;})
                        .rollup(function(calories) {
                        return {
                            "averageCalories" : d3.mean(calories, function(d) {return(d.Calories)}) // Return the average score 
                            }
                    })
                        .entries(calories);
                
                for(var i = 0; i < caloriesData.length; i++){
                
                        var n = Object.values(caloriesData[i].value)
                        var x = Number(n);

                        var calorieInfo = { fastfood : caloriesData[i].key,
                                            kcal: x
                                          }

                        C.push(calorieInfo);
                    }
                
                
                for(var i = 0; i < income.length; i++){
                
                    var info = { fastfood : income[i].fastfood,
                                income : income[i].SYSTEMWIDESALES
                               }
                    I.push(info)

                }
                
                //merging arrays created by processing the three csv files.
                
                for (var i1 = 0; i1 < C.length; i1++) 
                {
                    for (var i2 = 0; i2 < P.length; i2++) 
                    {

                        if (C[i1].fastfood == P[i2].fastfood)
                        {
                        
                            if (C[i1].fastfood == imageRef[i2].name)
                            {
                                
                                var info = {
                                    fastfood : C[i1].fastfood, 
                                    calories : C[i1].kcal, 
                                    avgPrice : P[i2].cost, 
                                    logo : imageRef[i2].logo
                                    }
                           
                            merged.push(info);
                            }
                        }
                    }
                }

          
            
                for (var x = 0; x < merged.length; x++){

                    for ( var y = 0; y < I.length; y++){
                    
                        if (merged[x].fastfood == I[y].fastfood){
                        
                            var i = Number(I[y].income);
                            merged[x].income = i;
                        }
                    }
                }
	
			var mapp = usmap.selectAll('path').data(states.features).enter().append("path")
				.attr("d", path).attr("stroke", "black").style("fill", function (state) {
				if (restmap.get(state.id)){
					var s = restmap.get(state.id);
					return color_r(restmap.get(state.id)["Fast-food restaurants per 10,000 residents"]);  } 
				});
                
  
                scatterPlot(merged, us, mapp);
            });

            var y = d3.scaleLinear()
                .domain([0, 850])
                .range([500, 0]);
            
            var caloriesAxis = d3.axisLeft(y);
            
            var x = d3.scaleLinear()
                .domain([0, 9])
                .range([0, 500]);
            
           
            var priceAxis = d3.axisBottom(x);
            
            // x-axis
              svg.append("g")
                  .attr("class", "Xaxis")
                  .attr("transform", "translate("+margin.left+", 500 )")
                  .call(priceAxis);
            
            svg.append("text")             
                .attr("transform","translate(" + ((width + 50)/2) + " ," + (height + margin.top + 20) + ")")
                .style("font-family", "Quicksand")
                .style("text-anchor", "middle")
                .text("Price ($)");

            // y-axis
              svg.append("g")
                  .attr("class", "Yaxis")
                  .attr("transform", "translate("+margin.left+", 0)")
                  .call(caloriesAxis);
                
            svg.append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", margin.left-50)
                .attr("x",0 - (height / 2))
                .attr("dy", "1em")
                .style("text-anchor", "middle")
                .style("font-family", "Quicksand")
                .text("Calories");    
                
                        
        function scatterPlot(merged, us, mapp){

//            var averageCaloriesGirl = svg.append("line")
//                    .attr("x1", margin.left)                       
//                    .attr("y1", y(666.6))
//                    .attr("x2", 750)
//                    .attr("y2", y(666.6))
//                    .attr("stroke-width", 1.5)
//                    .attr("stroke", "pink");
//
//           
//            var averageCaloriesGirl = svg.append("line")
//                    .attr("x1", margin.left)                       
//                    .attr("y1", y(833))
//                    .attr("x2", 750)
//                    .attr("y2", y(833))
//                    .attr("stroke-width", 1.5)
//                    .attr("stroke", "blue");
                
//            var images = svg.append("g").selectAll('points')
//                .data(merged)
//				.enter()
//				.append("circle")
//                .attr("class", "dot")
//                .attr("r", function(d){ return (d.income / 35447)*100})
//                .attr("cx", function(d){ return x(d.avgPrice) })
//                .attr("cy", function(d){ return y(d.calories) })
//                .style("fill", "url(d.logo)")
//                .attr("stroke-width", 1.5)
//                .attr("stroke", "pink")
//                .style("opacity", opacity = "0.8")
//				.on("click", function (){click(d3.select(this).text())});
            
//            images.append("image")
//                .attr("xlink:href", merged.logo)
//                .attr("x", -8)
//                .attr("y", -8)
//                .attr("width", 16)
//                .attr("height", 16);

			
            var images = svg.append("g").selectAll('points')
                .data(merged)
                .enter()
                .append('image')
                .attr("xlink:href", function(d){ return d.logo })
                .attr("x", function(d){ return x(d.avgPrice) })
                .attr("y", function(d){ return y(d.calories) })
                .attr("width", 60)
                .attr("height", 60)
				.on("click", function (d){
				      var states = topojson.feature(us, us.objects.states);
				      click(d.fastfood, states, mapp);});
            
        }
    

	
            function click(n, states, mapp) {
                
                var stat = "";
                
                var restmap = d3.map(freq, function (d) { return d["FIPS"];} );
                
                var ext = d3.extent(freq, function(d) {
			         return d[n];
		          });
		
                var color_r = d3.scaleQuantize()
                    .domain(ext)
                    .range(["#ffffff", "#ffdacc", "##ffb699", "#ffa07a", "#ff7f4d", "#ff5b1a", "#e64100", "#b33300", "#802400", "#4d1600"]);
                
                mapp.style("fill", function (state) {
				console.log(color_r);	
                    
                    stat = state;
                    
                    if (restmap.get(state.id)){
				
                        console.log(restmap.get(state.id));
                        
                        return color_r(restmap.get(state.id)[n]);  
		  
                    } 
                    
                }); 		

	       };			
	
            
        </script>
    </body>
</html>